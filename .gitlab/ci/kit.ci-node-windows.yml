# Breslov Academy — Windows Node CI (lint/test/build/zip)

lint:
  stage: lint
  extends: .win_node_base
  script:
    - npm run lint

typecheck:
  stage: test
  extends: .win_node_base
  script:
    - npm run typecheck

unit_tests:
  stage: test
  extends: .win_node_base
  script:
    - |
      $pkg = Get-Content -Raw package.json | ConvertFrom-Json
      if ($null -ne $pkg.scripts.test -and $pkg.scripts.test -ne "") {
        npm test
      } else {
        Write-Host "No test script in package.json — skipping."
      }

build:
  stage: build
  extends: .win_node_base
  script:
    - npm run build
  artifacts:
    when: always
    expire_in: 14 days
    paths:
      - dist/

zip_stable:
  stage: zip
  extends: .win_node_base
  needs:
    - job: build
      artifacts: true
  script:
    - New-Item -ItemType Directory -Force -Path artifacts | Out-Null
    - |
      $ver = if ($env:CI_COMMIT_TAG) { $env:CI_COMMIT_TAG } else { "dev-" + $env:CI_COMMIT_SHORT_SHA }
      pwsh -File scripts/release.ps1 -Version $ver -OutDir (Resolve-Path artifacts) -IncludeDist
    - |
      $latest = Get-ChildItem -Path artifacts -Filter "breslov-academy-*.zip" |
        Sort-Object LastWriteTime -Descending |
        Select-Object -First 1

      if (-not $latest) { throw "Expected release ZIP not found in artifacts/" }

      $ref = if ($env:CI_COMMIT_TAG) { $env:CI_COMMIT_TAG } else { $env:CI_COMMIT_SHORT_SHA }
      $target = Join-Path (Resolve-Path artifacts) ("breslov-academy-" + $ref + ".zip")

      Move-Item -LiteralPath $latest.FullName -Destination $target -Force
      Write-Host ("Stable ZIP: " + $target)

      Copy-Item -LiteralPath BUILDINFO.json -Destination artifacts/BUILDINFO.json -Force
      Copy-Item -LiteralPath checksums.sha256 -Destination artifacts/checksums.sha256 -Force
  artifacts:
    when: always
    expire_in: 30 days
    paths:
      - artifacts/breslov-academy-*.zip
      - artifacts/checksums.sha256
      - artifacts/BUILDINFO.json
